<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>台灣小吃部｜小吃店式線上學習</title>
  <meta name="description" content="台灣小吃部：用台味把手藝一份一份存下來。像小吃店菜單一樣簡單。" />
  <style>
    :root{
      --paper:#fbf5e6;
      --paper2:#fffaf0;
      --ink:#1f1f1f;
      --muted:#6b6b6b;
      --line:#e8dcc4;
      --stamp:#c62828;
      --green:#0f766e;
      --blue:#0b4f6c;
      --shadow: 0 14px 30px rgba(0,0,0,.10);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(900px 540px at 15% 0%, rgba(198,40,40,.10), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(15,118,110,.09), transparent 65%),
        linear-gradient(0deg, rgba(255,255,255,.35), rgba(255,255,255,.35)),
        var(--paper);
      line-height:1.55;
    }
    a{color:inherit}
    .container{max-width:980px;margin:0 auto;padding:0 16px}

    .topbar{
      position:sticky;top:0;z-index:30;
      background: rgba(251,245,230,.88);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line);
    }
    .topbar .inner{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 0;
      gap:12px;
    }
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;min-width:220px;}
    .mark{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(198,40,40,.98), rgba(198,40,40,.78));
      box-shadow: 0 10px 22px rgba(198,40,40,.20);
      position:relative;border:1px solid rgba(0,0,0,.08);
    }
    .mark:before{
      content:"";position:absolute;inset:5px;
      border:2px dashed rgba(255,255,255,.55);border-radius:10px;opacity:.85;
    }
    .mark:after{
      content:"小吃";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      color:white;font-weight:900;letter-spacing:.12em;font-size:12px;transform: rotate(-6deg);
      text-shadow: 0 2px 0 rgba(0,0,0,.12);
    }
    .brand-title{font-weight:950;letter-spacing:.08em}
    .brand-sub{font-family:var(--mono);font-size:11px;color:var(--muted)}
    .nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;font-size:14px;}
    .nav a{
      padding:6px 10px;border-radius:999px;text-decoration:none;color:var(--muted);
      border:1px solid transparent;background: transparent;
    }
    .nav a:hover{color:var(--ink);border-color:var(--line);background: rgba(255,255,255,.65);}

    .paper{
      background: var(--paper2);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;position:relative;
    }
    .paper.grid:before{
      content:"";position:absolute;inset:0;
      background:
        linear-gradient(var(--line) 1px, transparent 1px) 0 0/100% 34px,
        linear-gradient(90deg, var(--line) 1px, transparent 1px) 0 0/120px 100%;
      opacity:.45;pointer-events:none;
    }
    .paper .pad{padding:16px;position:relative}

    .hero{padding:18px 0 8px}
    .hero-grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;align-items:stretch}
    .stamp{
      display:inline-flex;align-items:center;gap:8px;
      border:2px solid var(--stamp);color:var(--stamp);
      border-radius:999px;padding:6px 10px;font-weight:950;letter-spacing:.10em;font-size:12px;
      user-select:none;transform: rotate(-1.5deg);background: rgba(255,255,255,.6);
    }
    h1{margin:10px 0 10px;font-size:28px;letter-spacing:.03em}
    .sub{margin:0 0 14px;color:var(--muted);max-width:60ch;font-size:15px}
    .btn{
      appearance:none;border:1px solid var(--line);
      background: rgba(255,255,255,.78);color:var(--ink);
      padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800;
      box-shadow: 0 2px 0 rgba(0,0,0,.04);
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{border-color: transparent;background: var(--stamp);color:white;box-shadow: 0 10px 20px rgba(198,40,40,.18);}
    .btn.green{border-color: rgba(15,118,110,.28);background: rgba(15,118,110,.10);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .note-pencil{
      font-family:var(--mono);font-size:12px;color:var(--muted);
      border-left:4px solid rgba(198,40,40,.25);padding-left:10px;
    }

    .board{
      border:2px solid rgba(31,31,31,.08);border-radius:14px;
      background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(17,24,39,.86));
      color: rgba(255,255,255,.92);
      padding:14px;box-shadow: 0 14px 26px rgba(0,0,0,.12);position:relative;
    }
    .board:before{
      content:"";position:absolute;left:14px;top:-8px;width:70px;height:14px;border-radius:999px;
      background: rgba(255,255,255,.25);transform: rotate(-2deg);filter: blur(.2px);
    }
    .board h3{margin:0 0 8px;font-size:14px;letter-spacing:.06em}
    .board .kv{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;
      font-family:var(--mono);font-size:12px;color: rgba(255,255,255,.75);
    }
    .kv .box{border:1px dashed rgba(255,255,255,.22);border-radius:12px;padding:10px;background: rgba(255,255,255,.06);}
    .chalk{
      margin-top:10px;padding-top:10px;border-top:1px dashed rgba(255,255,255,.18);
      font-size:12px;color: rgba(255,255,255,.75);line-height:1.6;
    }

    section{padding:14px 0}
    .section-head{display:flex;align-items:end;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .section-head h2{margin:0;font-size:18px;letter-spacing:.04em}
    .hint{color:var(--muted);font-size:13px}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;}
    .input, select{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background: rgba(255,255,255,.85);font-family:var(--sans);font-size:14px;outline:none;
    }
    .input{min-width:220px;flex:1}

    .tag{
      font-size:12px;padding:3px 8px;border:1px solid var(--line);border-radius:999px;
      color:var(--muted);background: rgba(255,255,255,.6);
    }
    .chipRow{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.65);font-size:13px;color:var(--muted);
      cursor:pointer;user-select:none;position:relative;
    }
    .chip.active{
      border-color: rgba(198,40,40,.35);background: rgba(198,40,40,.10);
      color: var(--ink);font-weight:900;
    }
    .chip.active:after{
      content:"已勾";font-family:var(--mono);font-size:10px;color: rgba(198,40,40,.85);margin-left:6px;
    }

    .menu{border-top:2px solid rgba(31,31,31,.08);background: rgba(255,255,255,.45);}
    .menu-row{
      display:grid;grid-template-columns: 1fr auto;gap:12px;
      padding:14px 16px;border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.50);cursor:pointer;position:relative;
    }
    .menu-row:hover{background: rgba(255,255,255,.82)}
    .menu-title{display:flex;gap:10px;flex-wrap:wrap;align-items:baseline}
    .menu-title b{font-size:15px}
    .menu-meta{font-family:var(--mono);font-size:12px;color:var(--muted);margin-top:4px}
    .price{font-family:var(--mono);font-size:12px;color:var(--muted);text-align:right;white-space:nowrap;}
    .favStar{font-size:14px;color: rgba(198,40,40,.85);margin-right:6px;}
    .scribble{font-family:var(--mono);font-size:11px;color: rgba(31,31,31,.45);}

    .news{display:grid;grid-template-columns:1fr;gap:10px}
    .note{padding:12px 14px;border:1px solid var(--line);border-radius:14px;background: rgba(255,255,255,.70);}
    .note b{display:block;margin:6px 0 4px}
    .note .d{font-family:var(--mono);font-size:12px;color:var(--muted)}
    .note p{margin:6px 0 0;color:var(--muted);font-size:14px}

    .try{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .try .box{border:2px dashed rgba(31,31,31,.10);border-radius:14px;padding:14px;background: rgba(255,255,255,.72);}
    .try h3{margin:0 0 8px;font-size:14px;letter-spacing:.04em}
    .fine{margin:0;color:var(--muted);font-size:13px}

    footer{margin-top:18px;border-top:1px solid var(--line);padding:16px 0 22px;color:var(--muted);font-size:14px;}
    .foot{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .small{font-size:12px;color:var(--muted)}
    .right{text-align:right}

    .backdrop{
      position:fixed;inset:0;background: rgba(0,0,0,.28);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:60;
    }
    .modal{
      width:min(720px,100%);
      background: var(--paper2);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;position:relative;
    }
    .modal:before{
      content:"";position:absolute;inset:0;
      background:
        linear-gradient(var(--line) 1px, transparent 1px) 0 0/100% 34px,
        linear-gradient(90deg, var(--line) 1px, transparent 1px) 0 0/120px 100%;
      opacity:.35;pointer-events:none;
    }
    .modal-head{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 14px;border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.6);position:relative;
    }
    .modal-head b{letter-spacing:.06em}
    .modal-body{padding:14px;position:relative}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kv2{border:1px dashed rgba(31,31,31,.12);border-radius:14px;padding:12px;background: rgba(255,255,255,.65);}
    .kv2 .k{font-family:var(--mono);font-size:12px;color:var(--muted)}
    .kv2 .v{margin-top:6px;font-size:14px}
    .bars{display:grid;gap:8px;margin-top:10px}
    .bar{
      display:grid;grid-template-columns:70px 1fr 34px;gap:10px;align-items:center;
      font-family:var(--mono);font-size:12px;color:var(--muted);
    }
    .track{height:10px;border-radius:999px;background: rgba(0,0,0,.06);overflow:hidden;border:1px solid var(--line)}
    .fill{height:100%;background: rgba(198,40,40,.65)}
    .fill.alt{background: rgba(15,118,110,.60)}

    /* 試看影片 */
    .videoWrap{margin-top:10px;border:1px solid var(--line);border-radius:14px;overflow:hidden;background: rgba(255,255,255,.75);}
    .video{width:100%;aspect-ratio: 16/9;border:0;display:block;background:#000;}

    /* 人工模式 */
    .manualPanel{
      margin-top:12px;border:1px dashed rgba(31,31,31,.16);
      border-radius:14px;background: rgba(255,255,255,.70);
      padding:12px;display:none;
    }
    .manualHint{font-family:var(--mono);font-size:12px;color:var(--muted);margin:8px 0 0;line-height:1.6;}
    textarea.manualJson{
      width:100%;min-height:140px;font-family:var(--mono);font-size:12px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background: rgba(255,255,255,.85);
    }

    @media (max-width: 860px){
      .hero-grid{grid-template-columns:1fr}
      .try{grid-template-columns:1fr}
      .grid2{grid-template-columns:1fr}
      h1{font-size:24px}
      .input{min-width:160px}
      .brand{min-width:unset}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="container inner">
      <a class="brand" href="#top">
        <div class="mark" aria-hidden="true"></div>
        <div>
          <div class="brand-title">台灣小吃部</div>
          <div class="brand-sub">smalleat.tw｜MENU-STYLE LEARNING</div>
        </div>
      </a>
      <nav class="nav">
        <a href="#menu">菜單</a>
        <a href="#news">黑板</a>
        <a href="#try">先試吃</a>
        <a href="#contact">聯絡</a>
        <a href="#menu" id="btnManualNav" title="切換人工模式">人工模式</a>
      </nav>
    </div>
  </div>

  <main id="top" class="container">
    <div class="hero">
      <div class="paper grid">
        <div class="pad hero-grid">
          <div>
            <div class="stamp">小吃部招牌｜台味味譜保存計畫</div>
            <h1>像小吃店點餐一樣，<br/>把手藝一份一份傳下去。</h1>
            <p class="sub">
              免登入就能看菜單、看公告、先試吃。<br/>
              真的要付費或跨裝置同步，再加會員就好。
            </p>
            <div class="row">
              <a class="btn primary" href="#menu">先看菜單</a>
              <a class="btn green" href="#try">先試吃</a>
              <button class="btn" id="btnShowFav">我的收藏</button>
            </div>
            <p class="note-pencil" style="margin-top:12px">
              手寫小字：你今天想要「鹹香、微辣、下酒」？用下面的籤勾一勾就找到。
            </p>
          </div>

          <div class="board" aria-label="店門口小黑板">
            <h3>店門口小黑板</h3>
            <div class="kv">
              <div class="box">今日上架<br/><b id="todayCount">—</b></div>
              <div class="box">熱門分類<br/><b id="topCat">—</b></div>
              <div class="box">收藏數<br/><b id="favCount">0</b></div>
              <div class="box">營業狀態<br/><b>OPEN</b></div>
            </div>
            <div class="chalk">
              • 資料來源：<code>data/courses.json</code>（或人工模式）<br/>
              • 先做味譜（鹹甜酸辣鮮麻）→ 未來再擴充食感、歸屬感
            </div>
          </div>
        </div>
      </div>
    </div>

    <section id="menu">
      <div class="section-head">
        <h2>菜單（熱門課程）</h2>
        <div class="hint">像看菜單一樣簡單</div>
      </div>

      <div class="paper grid">
        <div class="pad">
          <div class="controls">
            <input class="input" id="q" placeholder="想學什麼？例如：滷肉、雞排、珍奶…" />
            <select id="cat"><option value="">全部分類</option></select>
            <select id="level">
              <option value="">全部程度</option>
              <option value="入門">入門</option>
              <option value="中階">中階</option>
              <option value="進階">進階</option>
            </select>
            <button class="btn" id="btnReset">清除</button>
          </div>

          <div class="chipRow" id="chipRow"></div>

          <div class="manualPanel" id="manualPanel" aria-label="人工模式面板">
            <div class="row" style="justify-content:space-between">
              <b>人工模式（手動貼 JSON 菜單）</b>
              <div class="row">
                <button class="btn green" id="btnLoadDemo">載入示範</button>
                <button class="btn" id="btnApplyManual">套用</button>
                <button class="btn" id="btnClearManual">清除</button>
              </div>
            </div>
            <p class="manualHint">
              直接貼「courses 陣列」：必須是 <code>[{...},{...}]</code>。<br/>
              若要試看影片：加 <code>"previewUrl":"https://www.youtube.com/shorts/xxxx"</code>
            </p>
            <textarea class="manualJson" id="manualJson"></textarea>
          </div>
        </div>

        <div class="menu" id="menuList">
          <div class="menu-row">
            <div class="menu-title"><b>載入中…</b><span class="tag">請稍等</span></div>
            <div class="price">—</div>
          </div>
        </div>
      </div>
    </section>

    <section id="news">
      <div class="section-head">
        <h2>黑板公告</h2>
        <div class="hint">像店門口的小黑板</div>
      </div>
      <div class="news" id="newsList"></div>
    </section>

    <section id="try">
      <div class="section-head">
        <h2>先試吃（免登入體驗）</h2>
        <div class="hint">先玩一下再決定要不要買單</div>
      </div>
      <div class="paper">
        <div class="pad try">

          <div class="box">
            <h3>1 分鐘小測驗</h3>
            <p class="fine">Q：滷製時「小火」的主要目的？</p>
            <div class="row" style="margin-top:10px">
              <button class="btn" data-ans="A">A. 讓表面焦香更快</button>
              <button class="btn" data-ans="B">B. 讓味道慢慢滲入</button>
              <button class="btn" data-ans="C">C. 降低成本</button>
            </div>
            <p id="quizOut" class="fine" style="margin-top:10px"></p>
          </div>

          <div class="box">
            <h3>試看影片（示範）</h3>
            <p class="fine">先用這支短影音當測試：達香滷肉飯（YouTube Shorts）。</p>
            <div class="videoWrap">
              <iframe
                id="tryVideo"
                class="video"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                referrerpolicy="strict-origin-when-cross-origin"
                title="試看影片"
                src="">
              </iframe>
            </div>
          </div>

          <div class="box">
            <h3>快速推薦（示範）</h3>
            <p class="fine">輸入你今天想要的感覺，我幫你挑 3 道。</p>
            <div class="row" style="margin-top:10px">
              <input class="input" id="mood" placeholder="例如：脆、微辣、下酒" />
              <button class="btn primary" id="btnPick">幫我挑</button>
            </div>
            <div id="pickOut" class="fine" style="margin-top:10px"></div>
            <p class="scribble" style="margin-top:10px">（這塊之後可以升級成味譜探索器）</p>
          </div>

        </div>
      </div>
    </section>

    <footer id="contact">
      <div class="container">
        <div class="foot">
          <div>
            <b>聯繫我們</b><br/>
            Email：<a href="mailto:smalleat.tw@gmail.com">smalleat.tw@gmail.com</a><br/>
            IG：<span>@smalleat.tw</span><br/>
            <span class="small">（IG 尚未申請，先用這個帳號名）</span>
          </div>
          <div class="right">
            <span class="small">© <span id="year"></span> 台灣小吃部</span><br/>
            <span class="small">台味小吃店風｜極簡一頁式</span>
          </div>
        </div>
      </div>
    </footer>
  </main>

  <!-- Course Modal -->
  <div class="backdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <b id="mTitle">菜單詳情</b>
        <div class="row">
          <button class="btn" id="btnFav">收藏 ☆</button>
          <button class="btn" id="btnClose">關閉</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="grid2">
          <div class="kv2">
            <div class="k">基本資訊</div>
            <div class="v" id="mMeta">—</div>
            <p class="fine" id="mSummary" style="margin-top:10px">—</p>
            <div class="row" id="mTags" style="margin-top:10px;flex-wrap:wrap"></div>

            <!-- 課程試看：有 previewUrl 才顯示 -->
            <div id="mVideoWrap" class="videoWrap" style="display:none">
              <iframe
                id="mVideo"
                class="video"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                referrerpolicy="strict-origin-when-cross-origin"
                title="課程試看"
                src="">
              </iframe>
            </div>
            <p id="mVideoHint" class="scribble" style="margin-top:10px;display:none">（試看影片）</p>
          </div>

          <div class="kv2">
            <div class="k">台味味譜（0–5）</div>
            <div class="bars" id="mBars"></div>
            <p class="fine" style="margin-top:10px">※ 先做味譜，之後再擴充食感/歸屬感。</p>
          </div>
        </div>

        <div class="row" style="margin-top:12px;justify-content:flex-end">
          <a class="btn green" href="#try" onclick="closeModal()">先試吃</a>
          <a class="btn primary" href="mailto:smalleat.tw@gmail.com?subject=%E8%AA%B2%E7%A8%8B%E8%A9%A2%E5%95%8F%EF%BC%9A%E5%8F%B0%E7%81%A3%E5%B0%8F%E5%90%83%E9%83%A8" onclick="closeModal()">我要詢問</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- State ----------
    let courses = [];
    let filtered = [];
    let activeTag = "";
    let currentCourseId = "";
    const FAV_KEY = "smalleat_favs_v1";

    const news = [
      { date:"2026-01-27", title:"台味小吃店風上線", body:"先把網站動起來：菜單、黑板公告、免登入試吃。"},
      { date:"2026-01-25", title:"課程資料用 courses.json", body:"前端讀本地 JSON，快又省。之後再接試算表同步。"},
      { date:"2026-01-20", title:"味譜系統", body:"先做味譜（鹹甜酸辣鮮麻），未來再加食感/歸屬感。"}
    ];

    // ---------- Helpers ----------
    const $ = (s)=>document.querySelector(s);
    const esc = (s)=>String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
    const uniq = (arr)=>Array.from(new Set(arr.filter(Boolean)));
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

    // ===== Manual Mode + Preview Video =====
    const MANUAL_MODE_KEY = "smalleat_manual_mode_v1";
    const MANUAL_DATA_KEY = "smalleat_manual_courses_v1";
    const TRY_VIDEO_URL = "https://www.youtube.com/shorts/gFJ1jJIgRtk";

    function toYouTubeEmbed(url){
      const s = String(url || "").trim();
      if(!s) return "";
      try{
        const u = new URL(s);
        if(u.hostname.includes("youtu.be")){
          const id = u.pathname.replace("/","").trim();
          return id ? `https://www.youtube.com/embed/${id}` : "";
        }
        if(u.hostname.includes("youtube.com") && u.pathname.startsWith("/shorts/")){
          const id = u.pathname.split("/shorts/")[1]?.split(/[/?#]/)[0];
          return id ? `https://www.youtube.com/embed/${id}` : "";
        }
        if(u.hostname.includes("youtube.com") && u.pathname === "/watch"){
          const id = u.searchParams.get("v");
          return id ? `https://www.youtube.com/embed/${id}` : "";
        }
        if(u.hostname.includes("youtube.com") && u.pathname.startsWith("/embed/")){
          return s;
        }
      }catch(e){}
      return "";
    }

    function isManualMode(){ return localStorage.getItem(MANUAL_MODE_KEY) === "1"; }
    function setManualMode(on){
      localStorage.setItem(MANUAL_MODE_KEY, on ? "1" : "0");
      const panel = $("#manualPanel");
      if(panel) panel.style.display = on ? "block" : "none";
      const nav = $("#btnManualNav");
      if(nav) nav.textContent = on ? "人工模式：ON" : "人工模式";
    }

    function readManualCourses(){
      try{
        const raw = localStorage.getItem(MANUAL_DATA_KEY);
        if(!raw) return null;
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : null;
      }catch{ return null; }
    }
    function writeManualCourses(arr){ localStorage.setItem(MANUAL_DATA_KEY, JSON.stringify(arr)); }
    function demoCourses(){
      return [
        {
          id:"A001",
          title:"達香滷肉飯｜香到發亮",
          summary:"用店家邏輯教：火候、滷汁管理、隔夜更香。",
          minutes:3,
          level:"入門",
          category:"飯麵主食",
          tags:["熱門","家常","滷味"],
          previewUrl:"https://www.youtube.com/shorts/gFJ1jJIgRtk",
          flavour:{salty:4,sweet:2,sour:0,spicy:1,umami:4,numbing:0}
        }
      ];
    }

    function readFavs(){
      try{ return JSON.parse(localStorage.getItem(FAV_KEY) || "[]"); }catch{ return []; }
    }
    function writeFavs(ids){
      localStorage.setItem(FAV_KEY, JSON.stringify(ids));
      $("#favCount").textContent = String(ids.length);
    }
    function toggleFav(id){
      const ids = readFavs();
      const idx = ids.indexOf(id);
      if(idx >= 0) ids.splice(idx,1); else ids.push(id);
      writeFavs(ids);
      return ids.includes(id);
    }
    function isFav(id){ return readFavs().includes(id); }

    // ---------- Rendering ----------
    function renderNews(){
      const host = $("#newsList");
      host.innerHTML = news.map(n=>`
        <div class="note">
          <div class="d">${esc(n.date)}</div>
          <b>${esc(n.title)}</b>
          <p>${esc(n.body)}</p>
        </div>
      `).join("");
    }

    function renderCategoryOptions(){
      const cats = uniq(courses.map(c=>c.category));
      const sel = $("#cat");
      sel.innerHTML = `<option value="">全部分類</option>` + cats.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
    }

    function renderChips(){
      const allTags = uniq(courses.flatMap(c=>c.tags || []));
      const hot = ["熱門","人氣","最新","台味","夜市","家常","滷味","炸物","飲品"];
      const tags = uniq([...hot, ...allTags]).slice(0, 18);

      const host = $("#chipRow");
      host.innerHTML = tags.map(t=>`
        <span class="chip ${t===activeTag ? "active":""}" data-tag="${esc(t)}">${esc(t)}</span>
      `).join("");

      host.querySelectorAll(".chip").forEach(ch=>{
        ch.addEventListener("click", ()=>{
          const t = ch.getAttribute("data-tag");
          activeTag = (activeTag === t) ? "" : t;
          renderChips();
          applyFilter();
        });
      });
    }

    function renderMenu(list){
      const host = $("#menuList");
      if(!list.length){
        host.innerHTML = `
          <div class="menu-row">
            <div>
              <div class="menu-title"><b>找不到符合的菜單</b><span class="tag">換個關鍵字</span></div>
              <div class="menu-meta">小字：也可以點上面的籤（熱門/夜市/台味…）</div>
            </div>
            <div class="price">—</div>
          </div>
        `;
        return;
      }

      host.innerHTML = list.map(c=>{
        const meta = `${c.minutes ?? 0} 分｜${c.level || ""}｜${c.category || ""}`;
        const tags = (c.tags || []).slice(0,3);
        const star = isFav(c.id) ? "★" : "☆";
        return `
          <div class="menu-row" data-id="${esc(c.id)}">
            <div>
              <div class="menu-title">
                <b>${esc(c.title || "（未命名）")}</b>
                ${tags.map(t=>`<span class="tag">${esc(t)}</span>`).join("")}
              </div>
              <div class="menu-meta">
                <span class="scribble">NO.${esc(c.id)}</span> ｜ ${esc(meta)}
              </div>
            </div>
            <div class="price">
              <span class="favStar">${star}</span>收藏<br/>
              <span class="small">點我看詳情</span>
            </div>
          </div>
        `;
      }).join("");

      host.querySelectorAll(".menu-row").forEach(row=>{
        row.addEventListener("click", ()=>{
          openCourse(row.getAttribute("data-id"));
        });
      });
    }

    function updateBoard(){
      $("#todayCount").textContent = String(courses.length);

      const catCount = new Map();
      courses.forEach(c=>{
        const k = c.category || "其他";
        catCount.set(k, (catCount.get(k) || 0) + 1);
      });
      let top = "—", best = 0;
      for(const [k,v] of catCount.entries()){ if(v>best){ best=v; top=k; } }
      $("#topCat").textContent = top;

      writeFavs(readFavs());
    }

    // ---------- Filtering ----------
    function applyFilter(){
      const q = ($("#q").value || "").trim().toLowerCase();
      const cat = $("#cat").value || "";
      const level = $("#level").value || "";

      filtered = courses.filter(c=>{
        const inQ =
          !q ||
          (c.title || "").toLowerCase().includes(q) ||
          (c.summary || "").toLowerCase().includes(q) ||
          (c.category || "").toLowerCase().includes(q) ||
          (c.tags || []).some(t => String(t).toLowerCase().includes(q));

        const inCat = !cat || c.category === cat;
        const inLevel = !level || c.level === level;
        const inTag = !activeTag || (c.tags || []).includes(activeTag) || c.category === activeTag;

        return inQ && inCat && inLevel && inTag;
      });

      renderMenu(filtered);
    }

    // ---------- Modal ----------
    const backdrop = $("#backdrop");

    function stopVideo(iframe){
      try{ iframe.src = ""; }catch(e){}
    }

    function closeModal(){
      stopVideo($("#mVideo"));
      $("#mVideoWrap").style.display = "none";
      $("#mVideoHint").style.display = "none";

      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden","true");
      currentCourseId = "";
    }

    function openCourse(id){
      const c = courses.find(x=>x.id === id);
      if(!c) return;

      currentCourseId = id;
      $("#mTitle").textContent = c.title || "菜單詳情";
      $("#mMeta").textContent = `${c.minutes ?? 0} 分鐘｜${c.level || ""}｜${c.category || ""}`;
      $("#mSummary").textContent = c.summary || "（尚未填寫摘要）";

      const tags = uniq([...(c.tags||[]), ...(c.belonging||[])]);
      $("#mTags").innerHTML = tags.slice(0, 10).map(t=>`<span class="tag">${esc(t)}</span>`).join("");

      const f = c.flavour || {};
      const rows = [
        ["鹹", f.salty ?? 0, "fill"],
        ["甜", f.sweet ?? 0, "fill alt"],
        ["酸", f.sour ?? 0, "fill"],
        ["辣", f.spicy ?? 0, "fill alt"],
        ["鮮", f.umami ?? 0, "fill"],
        ["麻", f.numbing ?? 0, "fill alt"]
      ];
      $("#mBars").innerHTML = rows.map(([name,val,klass])=>{
        const v = clamp(Number(val)||0,0,5);
        return `
          <div class="bar">
            <span>${name}</span>
            <div class="track"><div class="${klass}" style="width:${v*20}%"></div></div>
            <span>${v}</span>
          </div>
        `;
      }).join("");

      const fav = isFav(id);
      $("#btnFav").textContent = fav ? "已收藏 ★" : "收藏 ☆";

      // 課程試看：有 previewUrl 才顯示
      const embed = toYouTubeEmbed(c.previewUrl);
      if(embed){
        $("#mVideo").src = embed;
        $("#mVideoWrap").style.display = "block";
        $("#mVideoHint").style.display = "block";
      }else{
        stopVideo($("#mVideo"));
        $("#mVideoWrap").style.display = "none";
        $("#mVideoHint").style.display = "none";
      }

      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden","false");
    }

    // ---------- Load ----------
    async function loadCourses(){
      if(isManualMode()){
        const manual = readManualCourses();
        if(manual){
          courses = manual;
          return;
        }
      }
      try{
        const res = await fetch("./data/courses.json", { cache: "no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        courses = Array.isArray(data) ? data : [];
      }catch(err){
        console.error("courses.json 讀取失敗：", err);
        courses = [];
      }
    }

    // ---------- Events ----------
    function bindEvents(){
      $("#btnReset").addEventListener("click", ()=>{
        $("#q").value = "";
        $("#cat").value = "";
        $("#level").value = "";
        activeTag = "";
        renderChips();
        applyFilter();
      });

      ["q","cat","level"].forEach(id=>{
        $("#"+id).addEventListener("input", applyFilter);
        $("#"+id).addEventListener("change", applyFilter);
      });

      document.querySelectorAll("[data-ans]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const ans = btn.getAttribute("data-ans");
          $("#quizOut").textContent = (ans==="B")
            ? "✅ 對：小火讓味道慢慢滲入，也比較穩定不易焦。"
            : "❌ 不太對：提示是『慢慢滲入』與『穩定』。";
        });
      });

      $("#btnPick").addEventListener("click", ()=>{
        if(!courses.length){ $("#pickOut").textContent = "目前沒有菜單資料。"; return; }
        const shuffled = [...courses].sort(()=>Math.random()-0.5).slice(0,3);
        $("#pickOut").innerHTML = shuffled.map(c=>`• <a href="#menu" onclick="openCourse('${esc(c.id)}')">${esc(c.title)}</a>`).join("<br/>");
      });

      $("#btnShowFav").addEventListener("click", ()=>{
        const ids = readFavs();
        if(!ids.length){ alert("你還沒有收藏。先點幾個菜單看看～"); return; }
        const list = courses.filter(c=>ids.includes(c.id));
        const names = list.map(c=>`• ${c.title}`).join("\n");
        alert("我的收藏：\n" + names);
      });

      $("#btnClose").addEventListener("click", closeModal);
      backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(); });

      $("#btnFav").addEventListener("click", ()=>{
        if(!currentCourseId) return;
        const nowFav = toggleFav(currentCourseId);
        $("#btnFav").textContent = nowFav ? "已收藏 ★" : "收藏 ☆";
        applyFilter();
      });

      // 人工模式：切換（阻止 a 跳動）
      $("#btnManualNav").addEventListener("click", (e)=>{
        e.preventDefault();
        setManualMode(!isManualMode());
      });

      $("#btnLoadDemo").addEventListener("click", ()=>{
        $("#manualJson").value = JSON.stringify(demoCourses(), null, 2);
      });

      $("#btnApplyManual").addEventListener("click", async ()=>{
        try{
          const raw = ($("#manualJson").value || "").trim();
          const parsed = JSON.parse(raw);
          if(!Array.isArray(parsed)) throw new Error("必須是陣列格式");
          writeManualCourses(parsed);
          setManualMode(true);

          await loadCourses();
          updateBoard();
          renderCategoryOptions();
          renderChips();
          applyFilter();
          alert("已套用人工模式菜單 ✅");
        }catch(e){
          alert("JSON 格式不正確，或不是陣列。請再檢查一下。");
        }
      });

      $("#btnClearManual").addEventListener("click", async ()=>{
        localStorage.removeItem(MANUAL_DATA_KEY);
        setManualMode(false);

        await loadCourses();
        updateBoard();
        renderCategoryOptions();
        renderChips();
        applyFilter();
        alert("已清除手動資料，回到 courses.json ✅");
      });
    }

    // ---------- Init ----------
    window.addEventListener("DOMContentLoaded", async ()=>{
      $("#year").textContent = new Date().getFullYear();

      // ✅ 試看影片：在 DOM ready 後再塞 src
      const tv = $("#tryVideo");
      if(tv){
        const embed = toYouTubeEmbed(TRY_VIDEO_URL);
        if(embed) tv.src = embed;
      }

      // ✅ 人工模式狀態
      setManualMode(isManualMode());

      renderNews();
      bindEvents();

      await loadCourses();
      updateBoard();
      renderCategoryOptions();
      renderChips();
      applyFilter();
    });
  </script>
</body>
</html>
